<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- 1. Create sequence for dependencies -->
    <changeSet id="7-create-seq-dependencies" author="adruida">
        <createSequence sequenceName="dependency_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <!-- 2. Create dependencies table -->
    <changeSet id="8-dependencies-table" author="adruida">
        <createTable tableName="dependencies" schemaName="${schemaName}">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="position" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="active" type="BOOLEAN"/>
            <column name="created" type="TIMESTAMP"/>
        </createTable>

        <!-- Set default sequence for id -->
        <addDefaultValue
                tableName="dependencies"
                columnName="id"
                defaultValueComputed="nextval('dependency_seq')"
                columnDataType="BIGINT"/>
    </changeSet>

    <!-- 3. Create join table for servis and dependencies -->
    <changeSet id="9-create-join-table" author="adruida">
        <createTable tableName="servis_dependency" schemaName="${schemaName}">
            <column name="servis_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="dependency_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Add foreign keys -->
        <addForeignKeyConstraint
                baseTableName="servis_dependency"
                baseColumnNames="servis_id"
                referencedTableName="servis"
                referencedColumnNames="id"
                constraintName="fk_servis_dependency_servis"
                onDelete="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="servis_dependency"
                baseColumnNames="dependency_id"
                referencedTableName="dependencies"
                referencedColumnNames="id"
                constraintName="fk_servis_dependency_dependency"
                onDelete="CASCADE"/>

        <!-- Optional: add unique constraint to prevent duplicates -->
        <addUniqueConstraint
                tableName="servis_dependency"
                columnNames="servis_id, dependency_id"
                constraintName="uk_servis_dependency"/>
    </changeSet>
</databaseChangeLog>